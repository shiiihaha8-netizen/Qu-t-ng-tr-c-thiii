<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>H·ªá Th·ªëng H·∫°t T∆∞∆°ng T√°c Three.js</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #020202; }
        
        #input_video {
            position: absolute;
            bottom: 50px; 
            right: 20px;
            width: 240px;
            height: auto;
            border: 2px solid rgba(0, 255, 255, 0.3);
            border-radius: 12px;
            z-index: 100;
            transform: scaleX(-1);
            opacity: 0.7;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        
        #credit {
            position: absolute;
            bottom: 15px;
            right: 20px;
            color: #00ffff;
            font-family: 'Segoe UI', Arial, sans-serif;
            font-weight: bold;
            font-size: 16px;
            z-index: 200;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.8);
            pointer-events: none;
            letter-spacing: 1px;
        }

        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #ffffff; font-family: 'Arial'; font-weight: bold; font-size: 22px;
            text-shadow: 0 0 15px #00ffff; pointer-events: none; text-align: center;
            z-index: 101;
        }

        #hud {
            position: absolute; top: 20px; left: 20px;
            color: #fff; font-family: 'Segoe UI', Roboto, monospace; font-size: 14px; 
            pointer-events: none;
            background: rgba(0, 0, 0, 0.7); padding: 20px; border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            box-shadow: 0 0 30px rgba(0,255,255,0.1);
        }
        .highlight { color: #00ffcc; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;}
        .gold { color: #ffcc00; font-weight: bold; }
        .love { color: #ff3388; font-weight: bold; }
        hr { border: none; border-top: 1px solid rgba(255,255,255,0.2); margin: 12px 0; }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
</head>
<body>

<div id="loading">‚ú® ƒêang kh·ªüi ƒë·ªông h·ªá th·ªëng...<br>Vui l√≤ng c·∫•p quy·ªÅn Camera.</div>

<div id="hud">
    <div>üëã <span class="highlight">Tay Tr√°i</span>: ƒêi·ªÅu khi·ªÉn n·ªôi dung</div>
    <div style="margin-top:5px">‚Ä¢ 1 ng√≥n: Hello <span style="color:#00ffff">(Xanh Neon)</span></div>
    <div>‚Ä¢ 2 ng√≥n: Thi T·ªët <span class="gold">(V√†ng Kim)</span></div>
    <div>‚Ä¢ 3 ng√≥n: <span class="love"> Y√™u </span> (H·ªìng Ph·∫•n)</div>
    <hr>
    <div>‚úä <span class="highlight">Tay Ph·∫£i</span>: T∆∞∆°ng t√°c v·∫≠t l√Ω</div>
    <div style="margin-top:5px">‚Ä¢ <b>N·∫Øm ƒë·∫•m:</b> H·ªë ƒëen</div>
    <div>‚Ä¢ <b>X√≤e tay:</b> V·ª• n·ªï</div>
    <div>‚Ä¢ <b>L∆∞·ªõt qua:</b> D√≤ng ch·∫£y</div>
</div>

<video id="input_video"></video>
<div id="credit">T·∫ªn T·∫ªn</div>

<script>
    const CONFIG = {
        particleCount: 8000,
        particleSize: 4.5,
        returnSpeed: 0.12,
        friction: 0.92,
    };

    const THEMES = {
        1: { color1: new THREE.Color(0x00ffff), color2: new THREE.Color(0x8800ff) },
        2: { color1: new THREE.Color(0xffdd00), color2: new THREE.Color(0xff3300) },
        3: { color1: new THREE.Color(0xff0055), color2: new THREE.Color(0xffbbdd) }
    };

    let currentTheme = THEMES[1];
    let scene, camera, renderer, particles, geometry;
    let composer;
    let targetPositions = [];
    let currentPositions = [];
    let velocities = [];
    
    let interactionState = {
        mode: 1,
        rightHandPos: new THREE.Vector3(9999, 9999, 0),
        rightHandAction: 'neutral'
    };

    const width = window.innerWidth;
    const height = window.innerHeight;

    function initThree() {
        scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x000000, 0.0008);

        camera = new THREE.PerspectiveCamera(75, width / height, 1, 3000);
        camera.position.z = 600;

        renderer = new THREE.WebGLRenderer({ antialias: false, alpha: false, powerPreference: "high-performance" });
        renderer.setSize(width, height);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.2;
        document.body.appendChild(renderer.domElement);

        const renderScene = new THREE.RenderPass(scene, camera);
        const bloomPass = new THREE.UnrealBloomPass(new THREE.Vector2(width, height), 1.5, 0.4, 0.85);
        bloomPass.threshold = 0.0;
        bloomPass.strength = 3.5;
        bloomPass.radius = 0.85;

        composer = new THREE.EffectComposer(renderer);
        composer.addPass(renderScene);
        composer.addPass(bloomPass);

        initParticles();
        generateTextParticles("Hello");

        window.addEventListener('resize', onWindowResize, false);
        animate();
    }

    function initParticles() {
        geometry = new THREE.BufferGeometry();
        const positions = new Float32Array(CONFIG.particleCount * 3);
        const colors = new Float32Array(CONFIG.particleCount * 3);

        for (let i = 0; i < CONFIG.particleCount; i++) {
            positions[i * 3] = (Math.random() - 0.5) * 1500;
            positions[i * 3 + 1] = (Math.random() - 0.5) * 1500;
            positions[i * 3 + 2] = (Math.random() - 0.5) * 1000;

            colors[i * 3] = 1; colors[i * 3 + 1] = 1; colors[i * 3 + 2] = 1;

            currentPositions.push(new THREE.Vector3(positions[i*3], positions[i*3+1], positions[i*3+2]));
            velocities.push(new THREE.Vector3(0,0,0));
            targetPositions.push(new THREE.Vector3(0,0,0));
        }

        geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
        geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));

        const sprite = getTexture();

        const material = new THREE.PointsMaterial({
            size: CONFIG.particleSize,
            map: sprite,
            vertexColors: true,
            transparent: true,
            opacity: 1.0,
            blending: THREE.AdditiveBlending,
            depthWrite: false
        });

        particles = new THREE.Points(geometry, material);
        scene.add(particles);
    }

    function getTexture() {
        const canvas = document.createElement('canvas');
        canvas.width = 64; canvas.height = 64;
        const ctx = canvas.getContext('2d');
        const grad = ctx.createRadialGradient(32,32,0,32,32,32);
        grad.addColorStop(0, 'rgba(255,255,255,1)');
        grad.addColorStop(0.3, 'rgba(255,255,255,0.8)');
        grad.addColorStop(1, 'rgba(0,0,0,0)');
        ctx.fillStyle = grad;
        ctx.fillRect(0,0,64,64);
        const texture = new THREE.Texture(canvas);
        texture.needsUpdate = true;
        return texture;
    }

    function generateTextParticles(text) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const W = 1000; const H = 400;
        canvas.width = W; canvas.height = H;

        ctx.fillStyle = '#000000';
        ctx.fillRect(0, 0, W, H);
        
        ctx.fillStyle = '#ffffff';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.font = '900 150px "Microsoft YaHei", "Arial Black", sans-serif'; 
        ctx.fillText(text, W/2, H/2);

        const data = ctx.getImageData(0, 0, W, H).data;
        let validPoints = [];
        const step = 4;

        for(let y = 0; y < H; y += step) {
            for(let x = 0; x < W; x += step) {
                if(data[(y * W + x) * 4] > 128) {
                    validPoints.push({
                        x: (x - W / 2) * 2.2,
                        y: -(y - H / 2) * 2.2
                    });
                }
            }
        }

        validPoints.sort(() => Math.random() - 0.5);

        for (let i = 0; i < CONFIG.particleCount; i++) {
            if (i < validPoints.length) {
                targetPositions[i].set(validPoints[i].x, validPoints[i].y, 0);
            } else {
                const angle = Math.random() * Math.PI * 2;
                const r = 500 + Math.random() * 500;
                targetPositions[i].set(Math.cos(angle)*r, Math.sin(angle)*r, (Math.random()-0.5)*400);
            }
        }
    }

    const videoElement = document.getElementById('input_video');
    
    function onResults(results) {
        document.getElementById('loading').style.display = 'none';
        
        interactionState.rightHandPos.set(9999, 9999, 0);
        interactionState.rightHandAction = 'neutral';

        if (results.multiHandLandmarks && results.multiHandedness) {
            for (let index = 0; index < results.multiHandLandmarks.length; index++) {
                const classification = results.multiHandedness[index];
                const isRightHand = classification.label === 'Right'; 
                const landmarks = results.multiHandLandmarks[index];

                if (!isRightHand) { 
                    let fingers = 0;
                    if (landmarks[8].y < landmarks[6].y) fingers++;
                    if (landmarks[12].y < landmarks[10].y) fingers++;
                    if (landmarks[16].y < landmarks[14].y) fingers++;
                    if (landmarks[20].y < landmarks[18].y) fingers++;
                    
                    if (fingers === 1 && interactionState.mode !== 1) {
                        interactionState.mode = 1;
                        currentTheme = THEMES[1];
                        generateTextParticles("Hello");
                    } else if (fingers === 2 && interactionState.mode !== 2) {
                        interactionState.mode = 2;
                        currentTheme = THEMES[2];
                        generateTextParticles("Thi T·ªët");
                    } else if (fingers === 3 && interactionState.mode !== 3) {
                        interactionState.mode = 3;
                        currentTheme = THEMES[3];
                        generateTextParticles("Y√™u");
                    }
                } else {
                    const x = (1 - landmarks[9].x) * width - width / 2; 
                    const y = -(landmarks[9].y * height - height / 2);
                    interactionState.rightHandPos.set(x, y, 0);

                    const tip8 = landmarks[8];
                    const wrist = landmarks[0];
                    const dist = Math.sqrt(Math.pow(tip8.x - wrist.x, 2) + Math.pow(tip8.y - wrist.y, 2));
                    
                    if (dist < 0.18) interactionState.rightHandAction = 'fist';
                    else if (dist > 0.30) interactionState.rightHandAction = 'open';
                }
            }
        }
    }

    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({ 
        maxNumHands: 2,
        modelComplexity: 1,
        minDetectionConfidence: 0.7,
        minTrackingConfidence: 0.7
    });
    hands.onResults(onResults);

    const cam = new Camera(videoElement, {
        onFrame: async () => await hands.send({image: videoElement}),
        width: 640, height: 480
    });
    cam.start();

    const clock = new THREE.Clock();

    function animate() {
        requestAnimationFrame(animate);
        
        const time = clock.getElapsedTime();
        const positions = geometry.attributes.position.array;
        const colors = geometry.attributes.color.array;

        const rhPos = interactionState.rightHandPos;
        const rhAction = interactionState.rightHandAction;
        
        const tempColor = new THREE.Color(); 
        const targetColor1 = currentTheme.color1;
        const targetColor2 = currentTheme.color2;

        for (let i = 0; i < CONFIG.particleCount; i++) {
            const p = currentPositions[i];
            const v = velocities[i];
            const t = targetPositions[i];

            const mixRatio = (Math.sin(time * 1.5 + p.x * 0.0015) + 1) / 2; 
            tempColor.copy(targetColor1).lerp(targetColor2, mixRatio);

            if (rhPos.x !== 9999) {
                const distToHand = p.distanceTo(rhPos);
                if (distToHand < 250) {
                    let influence = 1 - (distToHand / 250);
                    tempColor.lerp(new THREE.Color(0xffffff), influence * 0.9);
                    tempColor.r *= 1.2; tempColor.g *= 1.2; tempColor.b *= 1.2;
                }
            }

            colors[i*3] = tempColor.r;
            colors[i*3+1] = tempColor.g;
            colors[i*3+2] = tempColor.b;

            const forceX = (t.x - p.x) * CONFIG.returnSpeed;
            const forceY = (t.y - p.y) * CONFIG.returnSpeed;
            const forceZ = (t.z - p.z) * CONFIG.returnSpeed;

            v.x += forceX; v.y += forceY; v.z += forceZ;

            v.x += (Math.random()-0.5) * 0.8;
            v.y += (Math.random()-0.5) * 0.8;
            v.z += (Math.random()-0.5) * 0.8;

            if (rhPos.x !== 9999) {
                const dx = p.x - rhPos.x;
                const dy = p.y - rhPos.y;
                const dz = p.z - rhPos.z;
                const distSq = dx*dx + dy*dy + dz*dz + 100;
                
                if (distSq < 50000) { 
                    const forceMagnitude = 15000 / distSq;
                    
                    if (rhAction === 'fist') {
                        v.x -= dx * forceMagnitude * 0.08;
                        v.y -= dy * forceMagnitude * 0.08;
                        v.z -= dz * forceMagnitude * 0.08;
                        v.x += dy * 0.05; 
                        v.y -= dx * 0.05;
                    } else if (rhAction === 'open') {
                        v.x += dx * forceMagnitude * 0.15;
                        v.y += dy * forceMagnitude * 0.15;
                        v.z += dz * forceMagnitude * 0.15 + 2;
                    } else {
                        v.x += dx * forceMagnitude * 0.02;
                        v.y += dy * forceMagnitude * 0.02;
                        v.z += dz * forceMagnitude * 0.02;
                    }
                }
            }

            v.x *= CONFIG.friction;
            v.y *= CONFIG.friction;
            v.z *= CONFIG.friction;

            p.add(v);

            positions[i * 3] = p.x;
            positions[i * 3 + 1] = p.y;
            positions[i * 3 + 2] = p.z;
        }

        geometry.attributes.position.needsUpdate = true;
        geometry.attributes.color.needsUpdate = true;
        
        composer.render();
    }

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
        composer.setSize(window.innerWidth, window.innerHeight);
    }

    initThree();
</script>
</body>
</html>

